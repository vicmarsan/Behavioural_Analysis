# For each population:

library(HMM)

states <- c("Heading odor","Heading bottom","Opposite to odor","Heading top")

startProb = c(0.3115463599958928, 0.23615874319745353, 0.2143803265222302, 0.23791457028442345)

HoProb <- c(0.9120841092233409, 0.04241715142626436, 0.0040538536328131435, 0.04144488571758153)
HbProb <- c(0.05410987195373813, 0.8979108241483511, 0.04337050805452292, 0.0046087958433879)
OoProb <- c(0.004981200756759346, 0.0457168857916038, 0.9014297004095122, 0.047872213042124676)
HtProb <- c(0.056927060854553305, 0.004596460940871817, 0.04044022442813983, 0.898036253776435)

transProb <- t(matrix(c(HoProb, HbProb, OoProb, HtProb),4))

elements <- c(225:360,0:224)

HoStateProb <- c(0.01138704, 0.01158479, 0.01077732, 0.01166719, 0.0117331 ,
                  0.01109042, 0.01161775, 0.01151888, 0.01194733, 0.0117331 ,
                  0.01076084, 0.0118155 , 0.01097507, 0.01153536, 0.01057957,
                  0.01143648, 0.01250762, 0.01133761, 0.01174958, 0.01217804,
                  0.01151888, 0.01130465, 0.0121286 , 0.01171663, 0.01206269,
                  0.0126065 , 0.01179902, 0.01198029, 0.01211212, 0.01184846,
                  0.01204621, 0.01290312, 0.01247466, 0.01242523, 0.01326566,
                  0.01226044, 0.01316678, 0.01270537, 0.01311735, 0.01230987,
                  0.01282072, 0.01329862, 0.01319974, 0.01183198, 0.01239227,
                  0.01216156, 0.01168367, 0.01234283, 0.01077732, 0.0117331 ,
                  0.01145296, 0.01064549, 0.01090915, 0.01082676, 0.01015111,
                  0.01029942, 0.01077732, 0.01021703, 0.0107938 , 0.01054661,
                  0.0100852 , 0.00990393, 0.00983801, 0.01024999, 0.00992041,
                  0.01034886, 0.00998632, 0.0100028 , 0.0096073 , 0.00987097,
                  0.00970618, 0.00922828, 0.01003576, 0.01057957, 0.01011816,
                  0.01005224, 0.01036534, 0.01049717, 0.01092563, 0.00942603,
                  0.00987097, 0.01015111, 0.00914589, 0.0096897 , 0.00975562,
                  0.00932716, 0.00916237, 0.00906349, 0.0085856 , 0.00995336,
                  0.        , 0.        , 0.        , 0.        , 0.        ,
                  0.        , 0.        , 0.        , 0.        , 0.        ,
                  0.        , 0.        , 0.        , 0.        , 0.        ,
                  0.        , 0.        , 0.        , 0.        , 0.        ,
                  0.        , 0.        , 0.        , 0.        , 0.        ,
                  0.        , 0.        , 0.        , 0.        , 0.        ,
                  0.        , 0.        , 0.        , 0.        , 0.        ,
                  0.        , 0.        , 0.        , 0.        , 0.        ,
                  0.        , 0.        , 0.        , 0.        , 0.        ,
                  0.        , 0.        , 0.        , 0.        , 0.        ,
                  0.        , 0.        , 0.        , 0.        , 0.        ,
                  0.        , 0.        , 0.        , 0.        , 0.        ,
                  0.        , 0.        , 0.        , 0.        , 0.        ,
                  0.        , 0.        , 0.        , 0.        , 0.        ,
                  0.        , 0.        , 0.        , 0.        , 0.        ,
                  0.        , 0.        , 0.        , 0.        , 0.        ,
                  0.        , 0.        , 0.        , 0.        , 0.        ,
                  0.        , 0.        , 0.        , 0.        , 0.        ,
                  0.        , 0.        , 0.        , 0.        , 0.        ,
                  0.        , 0.        , 0.        , 0.        , 0.        ,
                  0.        , 0.        , 0.        , 0.        , 0.        ,
                  0.        , 0.        , 0.        , 0.        , 0.        ,
                  0.        , 0.        , 0.        , 0.        , 0.        ,
                  0.        , 0.        , 0.        , 0.        , 0.        ,
                  0.        , 0.        , 0.        , 0.        , 0.        ,
                  0.        , 0.        , 0.        , 0.        , 0.        ,
                  0.        , 0.        , 0.        , 0.        , 0.        ,
                  0.        , 0.        , 0.        , 0.        , 0.        ,
                  0.        , 0.        , 0.        , 0.        , 0.        ,
                  0.        , 0.        , 0.        , 0.        , 0.        ,
                  0.        , 0.        , 0.        , 0.        , 0.        ,
                  0.        , 0.        , 0.        , 0.        , 0.        ,
                  0.        , 0.        , 0.        , 0.        , 0.        ,
                  0.        , 0.        , 0.        , 0.        , 0.        ,
                  0.        , 0.        , 0.        , 0.        , 0.        ,
                  0.        , 0.        , 0.        , 0.        , 0.        ,
                  0.        , 0.        , 0.        , 0.        , 0.        ,
                  0.        , 0.        , 0.        , 0.        , 0.        ,
                  0.        , 0.        , 0.        , 0.        , 0.        ,
                  0.        , 0.        , 0.        , 0.        , 0.        ,
                  0.        , 0.        , 0.        , 0.        , 0.        ,
                  0.        , 0.        , 0.        , 0.        , 0.        ,
                  0.        , 0.        , 0.        , 0.        , 0.        ,
                  0.        , 0.        , 0.        , 0.        , 0.        ,
                  0.        , 0.        , 0.        , 0.        , 0.        ,
                  0.        , 0.        , 0.        , 0.        , 0.        ,
                  0.        , 0.        , 0.        , 0.        , 0.        ,
                  0.        , 0.        , 0.        , 0.        , 0.        ,
                  0.        , 0.        , 0.        , 0.        , 0.        ,
                  0.        , 0.        , 0.        , 0.        , 0.        ,
                  0.        , 0.        , 0.        , 0.        , 0.        ,
                  0.        , 0.        , 0.        , 0.        , 0.        ,
                  0.        , 0.        , 0.        , 0.        , 0.        ,
                  0.        , 0.        , 0.        , 0.        , 0.        ,
                  0.        )
HbStateProb <- c(0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.00513055, 0.00976108, 0.01028283, 0.01071762, 0.01017413,
                 0.01056545, 0.01002196, 0.01071762, 0.01084806, 0.01054371,
                 0.01052197, 0.01093502, 0.01032631, 0.00973934, 0.01017413,
                 0.01089154, 0.01095676, 0.01134807, 0.01017413, 0.0109785 ,
                 0.01065241, 0.01028283, 0.01123937, 0.01063067, 0.01069588,
                 0.01141329, 0.01058719, 0.01113068, 0.01030457, 0.01056545,
                 0.01100024, 0.0110872 , 0.01147851, 0.01045675, 0.01080458,
                 0.01073936, 0.01060893, 0.01115242, 0.01102198, 0.01021761,
                 0.01100024, 0.01165243, 0.01117416, 0.01163069, 0.0111959 ,
                 0.01141329, 0.01278289, 0.01206548, 0.012022  , 0.01271767,
                 0.01158721, 0.01208722, 0.01241331, 0.01219592, 0.0110872 ,
                 0.01093502, 0.01134807, 0.01095676, 0.01063067, 0.01232635,
                 0.01171765, 0.01182634, 0.012022  , 0.01115242, 0.01176113,
                 0.01154373, 0.01165243, 0.01206548, 0.01173939, 0.0110872 ,
                 0.01226114, 0.01150025, 0.01167417, 0.01147851, 0.01143503,
                 0.01121764, 0.01193504, 0.01186982, 0.01210896, 0.01080458,
                 0.01165243, 0.01136981, 0.01139155, 0.01128285, 0.01008718,
                 0.01069588, 0.0100437 , 0.01136981, 0.01050023, 0.01036979,
                 0.0042827 , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        )
OoStateProb <- c(0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.01068084, 0.01199799, 0.01173456, 0.01338698,
                 0.01044136, 0.01283617, 0.01166272, 0.01139929, 0.01135139,
                 0.01161482, 0.01161482, 0.01192614, 0.01233326, 0.01202194,
                 0.01027373, 0.01159087, 0.0119022 , 0.01221352, 0.01142323,
                 0.01197404, 0.01115981, 0.01053716, 0.01221352, 0.01144718,
                 0.01154297, 0.01216562, 0.01183035, 0.01168666, 0.01080058,
                 0.01077664, 0.01106401, 0.01247695, 0.01187825, 0.01204588,
                 0.01274038, 0.01252485, 0.01274038, 0.01259669, 0.01218957,
                 0.01271643, 0.01257274, 0.01338698, 0.01235721, 0.01175851,
                 0.01235721, 0.01063295, 0.0118543 , 0.01171061, 0.01104007,
                 0.01202194, 0.01175851, 0.01130349, 0.01051321, 0.01209378,
                 0.01092032, 0.01156692, 0.01080058, 0.010609  , 0.01084848,
                 0.01106401, 0.01010609, 0.01041742, 0.00948344, 0.00991451,
                 0.00957923, 0.00957923, 0.01039347, 0.00969897, 0.0094116 ,
                 0.0099624 , 0.00950739, 0.01104007, 0.00960318, 0.01092032,
                 0.00883684, 0.01034557, 0.00977082, 0.0100103 , 0.01070479,
                 0.01027373, 0.00953134, 0.00984266, 0.01058505, 0.01034557,
                 0.00890869, 0.00943554, 0.00943554, 0.01072874, 0.00895658,
                 0.00998635, 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        )
HtStateProb <- c(0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.        , 0.        , 0.        , 0.        ,
                 0.        , 0.0081785 , 0.00940852, 0.00904167, 0.00856693,
                 0.00856693, 0.00897693, 0.0092143 , 0.00820008, 0.00884746,
                 0.0086964 , 0.00871798, 0.00804903, 0.00884746, 0.00856693,
                 0.00848061, 0.00850219, 0.0088043 , 0.00861009, 0.00878272,
                 0.00884746, 0.00914957, 0.00856693, 0.0092143 , 0.00882588,
                 0.00843745, 0.00889062, 0.00945167, 0.00884746, 0.00889062,
                 0.00917114, 0.00927904, 0.00856693, 0.00914957, 0.01001273,
                 0.0097322 , 0.00893377, 0.01001273, 0.01027168, 0.01018537,
                 0.00996957, 0.00940852, 0.01048747, 0.0108759 , 0.0102501 ,
                 0.01163117, 0.01160959, 0.01117801, 0.01074642, 0.01165275,
                 0.01061695, 0.01206275, 0.01230012, 0.0118038 , 0.01178222,
                 0.01173906, 0.01163117, 0.01227854, 0.01279644, 0.01251591,
                 0.01225696, 0.01292592, 0.01262381, 0.01266697, 0.01361645,
                 0.01288276, 0.01361645, 0.01478173, 0.01260223, 0.01348698,
                 0.01262381, 0.0128396 , 0.01337908, 0.01368119, 0.01333592,
                 0.01333592, 0.01340066, 0.01322803, 0.01385382, 0.0143933 ,
                 0.01424225, 0.01411277, 0.01299066, 0.01493278, 0.01493278,
                 0.01428541, 0.01519173, 0.01499752, 0.01445804, 0.01299066,
                 0.0145012)

emissProb <- matrix(c(HoStateProb,HbStateProb,OoStateProb,HtStateProb), 4, byrow = T) 

hmm <- initHMM(States = states, 
               Symbols = elements,
               transProbs=transProb,
               emissionProbs = emissProb)

hmm$startProbs["Heading odor"] <- startProb[1]
hmm$startProbs["Heading bottom"] <- startProb[2]
hmm$startProbs["Opposite to odor"] <- startProb[3]
hmm$startProbs["Heading top"] <- startProb[4]

print(hmm)
simhmm <- simHMM(hmm, 1000000)
simhmm_df <- as.data.frame(simhmm)
write.table(simhmm,file = "simulacion_control_odor",row.names = F)

table(simhmm_df$states)

pie(table(simhmm_df$states),main = "Proportion of orientations emptyUAS-odor",
    col = c("lightgreen","lightblue","purple","lightyellow"),)

# Steady-state equations. [Ho Hb Oo Ht]*(I-transmat) = 0

I = diag(4)
matriz <- I- transProb
matriz <- t(matriz)
matriz <- rbind(matriz,c(1,1,1,1))
vector <- c(0,0,0,0,1)

round(qr.solve(matriz,vector)*100,digits = 2)

# Simulations

sim <- read.table("simulacion_control_odor")
states_count <- table(sim$V1)
percentages <- round(prop.table(states_count)*100,digits = 2)
